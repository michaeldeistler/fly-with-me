<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NeuroQuest @ MPI‑BI</title>
    <meta name="description" content="Open Day mini‑game: visit stations, earn stamps, and climb the local leaderboard." />
    <!-- Tailwind Play CDN (sufficient for this small app) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD & Babel for JSX without a build step -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
      const formatMs = (ms) => `${Math.round(ms)} ms`;

      function useLocalStorage(key, initialValue) {
        const [value, setValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item, (k, v) => (v && v.__set ? new Set(v.values) : v)) : initialValue;
          } catch {
            return initialValue;
          }
        });
        useEffect(() => {
          try {
            const replacer = (k, v) => (v instanceof Set ? { __set: true, values: Array.from(v) } : v);
            window.localStorage.setItem(key, JSON.stringify(value, replacer));
          } catch {}
        }, [key, value]);
        return [value, setValue];
      }

      function Card({ title, children, footer, done }) {
        return (
          <div className={"rounded-2xl shadow p-5 bg-white border " + (done ? "border-green-400" : "border-gray-200")}>
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-xl font-semibold">{title}</h3>
              {done ? (
                <span className="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Stamped</span>
              ) : (
                <span className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">Do task</span>
              )}
            </div>
            <div>{children}</div>
            {footer && <div className="mt-4 text-sm text-gray-600">{footer}</div>}
          </div>
        );
      }
      function Button({ children, onClick, disabled, variant = "primary" }) {
        const base = "px-3 py-2 rounded-xl text-sm font-medium transition active:scale-[.98]";
        const styles = variant === "ghost"
          ? "border border-gray-200 hover:bg-gray-50"
          : disabled
          ? "bg-gray-300 text-white"
          : "bg-blue-600 text-white hover:bg-blue-700";
        return (
          <button className={`${base} ${styles}`} onClick={onClick} disabled={disabled}>{children}</button>
        );
      }

      function StationFlyEye({ onComplete, done }) {
        const [questionIndex, setQuestionIndex] = useState(0);
        const trials = useMemo(() => [
          { pattern: "▶▶▶▶▶", correct: "right" },
          { pattern: "◀◀◀◀◀", correct: "left" },
          { pattern: "▶▶◀◀▶", correct: "right" },
          { pattern: "◀▶◀▶◀", correct: "left" },
        ], []);
        const current = trials[questionIndex];
        function answer(dir) {
          if (dir === current.correct) {
            if (questionIndex === trials.length - 1) onComplete();
            else setQuestionIndex((i) => i + 1);
          } else {
            alert("Not quite — think how wide‑field motion drives turning.");
          }
        }
        return (
          <Card title="Fly‑Eye Illusions (Vision)" done={done} footer={<>Flies turn toward wide‑field motion (optomotor response). Which way does the pattern make you turn?</>}>
            <div className="flex items-center justify-between gap-3">
              <div className="text-4xl tracking-widest select-none font-mono">{current.pattern}</div>
              <div className="flex gap-2">
                <Button onClick={() => answer("left")}>Left</Button>
                <Button onClick={() => answer("right")}>Right</Button>
              </div>
            </div>
          </Card>
        );
      }

      function StationReaction({ onComplete, done, setBest }) {
        const [state, setState] = useState("idle");
        const [rt, setRt] = useState(null);
        const startTs = useRef(0);
        const timeoutRef = useRef(null);
        function begin() {
          setRt(null);
          setState("waiting");
          const delay = 600 + Math.random() * 1800;
          timeoutRef.current = setTimeout(() => {
            startTs.current = performance.now();
            setState("go");
          }, delay);
        }
        function tap() {
          if (state !== "go") {
            alert("Too early! Wait for the signal.");
            return;
          }
          const t = performance.now() - startTs.current;
          setRt(t);
          setBest && setBest((prev) => (prev === null ? t : Math.min(prev, t)));
          setState("done");
          if (t < 350) onComplete();
        }
        useEffect(() => () => clearTimeout(timeoutRef.current), []);
        return (
          <Card title="Synapse Snap (Reaction Time)" done={done} footer={<>Typical human visuo‑motor reaction ≈ 200–250 ms. Synaptic delay per synapse ~1–2 ms.</>}>
            <div className="flex flex-col sm:flex-row items-stretch gap-3">
              <div className="flex-1">
                {state === "idle" && (<Button onClick={begin}>Ready → Wait for signal</Button>)}
                {state === "waiting" && (<div className="p-3 rounded-xl bg-yellow-50 border border-yellow-200">Wait…</div>)}
                {state === "go" && (<Button onClick={tap}>TAP!</Button>)}
                {state === "done" && (
                  <div className="flex items-center gap-3">
                    <div className="p-2 rounded-xl bg-blue-50 border">Your RT: <b>{formatMs(rt)}</b></div>
                    <Button variant="ghost" onClick={begin}>Try again</Button>
                  </div>
                )}
              </div>
            </div>
          </Card>
        );
      }

      function StationModel({ onComplete, done }) {
        const target = useMemo(() => ({ mean: 60, noise: 18 }), []);
        const [mean, setMean] = useState(30);
        const [noise, setNoise] = useState(10);
        const err = Math.hypot(target.mean - mean, target.noise - noise);
        const matched = err < 12;
        useEffect(() => { if (matched) onComplete(); }, [matched, onComplete]);
        return (
          <Card title="Model in a Minute (Fit the knobs)" done={done} footer={<>Model fitting: adjust parameters so simulation ≈ data. Here, match mean and noise.</>}>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <div className="md:col-span-2">
                <div className="w-full h-28 bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl relative overflow-hidden">
                  <div className="absolute top-2 h-24 rounded-lg opacity-70" style={{ left: `${clamp(target.mean - target.noise, 0, 100)}%`, width: `${clamp(2*target.noise, 0, 100)}%`, background: "rgba(34,197,94,0.25)" }} />
                  <div className="absolute top-2 h-24 rounded-lg" style={{ left: `${clamp(mean - noise, 0, 100)}%`, width: `${clamp(2*noise, 0, 100)}%`, background: matched ? "rgba(34,197,94,0.5)" : "rgba(59,130,246,0.4)" }} />
                  <div className="absolute bottom-1 left-2 right-2 text-[10px] text-gray-600">0% … 100%</div>
                </div>
              </div>
              <div className="space-y-3">
                <div>
                  <label className="text-sm">Mean: {Math.round(mean)}</label>
                  <input type="range" min={0} max={100} value={mean} onChange={(e) => setMean(parseFloat(e.target.value))} className="w-full" />
                </div>
                <div>
                  <label className="text-sm">Noise (±): {Math.round(noise)}</label>
                  <input type="range" min={0} max={50} value={noise} onChange={(e) => setNoise(parseFloat(e.target.value))} className="w-full" />
                </div>
                <div className={"text-sm " + (matched ? "text-green-700" : "text-gray-600")}>
                  {matched ? "Matched!" : `Error ≈ ${Math.round(err)}`}
                </div>
              </div>
            </div>
          </Card>
        );
      }

      function StationMemory({ onComplete, done }) {
        const [pattern, setPattern] = useState(() => new Set());
        const [show, setShow] = useState(true);
        const [guess, setGuess] = useState(() => new Set());
        useEffect(() => {
          const cells = new Set();
          const n = 3 + Math.floor(Math.random() * 3);
          while (cells.size < n) cells.add(Math.floor(Math.random() * 9));
          setPattern(cells);
          setShow(true);
          const t = setTimeout(() => setShow(false), 2000);
          return () => clearTimeout(t);
        }, []);
        function toggle(i) {
          if (show) return;
          const g = new Set(guess);
          if (g.has(i)) g.delete(i); else g.add(i);
          setGuess(g);
        }
        function check() {
          let ok = pattern.size === guess.size;
          pattern.forEach((i) => (ok = ok && guess.has(i)));
          if (ok) onComplete();
          else alert("Close! Try again or hit Preview.");
        }
        function reset() {
          setGuess(new Set());
          setShow(true);
          setTimeout(() => setShow(false), 1600);
        }
        return (
          <Card title="Memory Maze (Working memory)" done={done} footer={<>Glance at the lit tiles. They vanish—can you reproduce the pattern?</>}>
            <div className="flex items-center gap-4">
              <div className="grid grid-cols-3 gap-2">
                {Array.from({ length: 9 }).map((_, i) => {
                  const lit = show ? pattern.has(i) : guess.has(i);
                  return (
                    <div key={i} onClick={() => toggle(i)} className={`w-14 h-14 rounded-xl border flex items-center justify-center cursor-pointer select-none ${lit ? "bg-blue-500 text-white" : "bg-white"} ${show ? "pointer-events-none opacity-80" : ""}`}>{lit ? "●" : ""}</div>
                  );
                })}
              </div>
              <div className="space-y-2">
                <Button onClick={check}>Check</Button>
                <div><Button variant="ghost" onClick={reset}>Preview</Button></div>
              </div>
            </div>
          </Card>
        );
      }

      function StationSpikes({ onComplete, done }) {
        const patterns = useMemo(() => [
          { id: "A", rows: ["|  |   |  |   |", " | |  | |  | |", "|  |   |  |   ", " | |  | |  | |"], label: "patterned" },
          { id: "B", rows: ["|    |  | |  |", "  | |   |  | |", " | |  | |  | ", "| |  |  | |  |"], label: "noisy" },
        ], []);
        const correct = "A";
        const [picked, setPicked] = useState(null);
        function choose(id) {
          setPicked(id);
          if (id === correct) onComplete();
          else alert("That one was the shuffled control. Look for repeating alignment.");
        }
        return (
          <Card title="Spike or Noise? (Find the structure)" done={done} footer={<>Brains detect temporal structure in spikes. Which raster shows a consistent pattern?</>}>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {patterns.map((p) => (
                <div key={p.id} className={`rounded-xl border p-3 ${picked === p.id ? "border-blue-400" : "border-gray-200"}`}>
                  <div className="font-mono text-sm leading-6 whitespace-pre">{p.rows.join("\n")}</div>
                  <div className="mt-2"><Button onClick={() => choose(p.id)}>Pick {p.id}</Button></div>
                </div>
              ))}
            </div>
          </Card>
        );
      }

      function TierBadge({ count }) {
        let tier = { name: "No tier yet", color: "bg-gray-100 text-gray-700" };
        if (count >= 4) tier = { name: "Gold", color: "bg-yellow-200 text-yellow-900" };
        else if (count >= 3) tier = { name: "Bronze", color: "bg-amber-100 text-amber-800" };
        return <span className={`px-2 py-1 rounded-full text-xs ${tier.color}`}>{tier.name}</span>;
      }

      function Passport({ stations, stamps, onReset }) {
        const count = stamps.size;
        return (
          <div className="rounded-2xl border p-4 bg-white">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-semibold">NeuroQuest Passport</h3>
              <TierBadge count={count} />
            </div>
            <div className="grid grid-cols-5 gap-2 mt-3">
              {stations.map((s) => (
                <div key={s.id} className={`aspect-square rounded-xl border flex items-center justify-center text-2xl ${stamps.has(s.id) ? "bg-green-100 border-green-300" : "bg-gray-50 border-gray-200"}`}>{stamps.has(s.id) ? "✳" : ""}</div>
              ))}
            </div>
            <div className="text-sm text-gray-600 mt-3">Complete all stations to earn <b>Gold</b>. This demo has 4 stations.</div>
            <div className="mt-3"><Button variant="ghost" onClick={onReset}>Reset passport</Button></div>
          </div>
        );
      }

      function Leaderboard({ name, setName, bestMs, stamps }) {
        const [board, setBoard] = useLocalStorage("neuroquest_board", []);
        const [saved, setSaved] = useState(false);
        const score = stamps.size * 1000 - Math.min(bestMs ?? 9999, 9999);
        function save() {
          if (!name) return alert("Enter a nickname first");
          const entry = { name, score, stamps: stamps.size, bestMs: bestMs ?? null, t: Date.now() };
          const updated = [...board, entry].sort((a, b) => b.score - a.score).slice(0, 20);
          setBoard(updated);
          setSaved(true);
        }
        return (
          <div className="rounded-2xl border p-4 bg-white">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-lg font-semibold">Local Leaderboard (demo)</h3>
              <div className="text-sm text-gray-500">Score = stamps×1000 − best RT</div>
            </div>
            <div className="flex items-center gap-2 mb-3">
              <input className="border rounded-xl px-3 py-2 text-sm w-40" placeholder="Nickname" value={name} onChange={(e) => setName(e.target.value)} />
              <Button onClick={save}>{saved ? "Saved" : "Save score"}</Button>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="text-left text-gray-600">
                    <th className="py-1 pr-4">#</th><th className="py-1 pr-4">Name</th><th className="py-1 pr-4">Stamps</th><th className="py-1 pr-4">Best RT</th><th className="py-1 pr-4">Score</th>
                  </tr>
                </thead>
                <tbody>
                  {board.map((r, i) => (
                    <tr key={r.name + r.t} className="border-t">
                      <td className="py-1 pr-4">{i + 1}</td>
                      <td className="py-1 pr-4">{r.name}</td>
                      <td className="py-1 pr-4">{r.stamps}</td>
                      <td className="py-1 pr-4">{r.bestMs ? formatMs(r.bestMs) : "—"}</td>
                      <td className="py-1 pr-4">{r.score}</td>
                    </tr>
                  ))}
                  {board.length === 0 && (<tr><td className="py-2 text-gray-500" colSpan="5">No scores yet. Be the first!</td></tr>)}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      function App() {
        const stations = [
          { id: "fly", title: "Fly‑Eye Illusions", Component: StationFlyEye },
          { id: "rt", title: "Synapse Snap", Component: StationReaction },
          { id: "model", title: "Model in a Minute", Component: StationModel },
          { id: "memory", title: "Memory Maze", Component: StationMemory },
          { id: "spikes", title: "Spike or Noise?", Component: StationSpikes },
        ];
        const [stamps, setStamps] = useLocalStorage("neuroquest_stamps", new Set());
        const [bestMs, setBestMs] = useLocalStorage("neuroquest_best_rt", null);
        const [name, setName] = useLocalStorage("neuroquest_name", "");

        function handleComplete(id) {
          setStamps((prev) => {
            const s = new Set(prev instanceof Set ? prev : prev);
            s.add(id);
            return s;
          });
        }
        function resetPassport() { setStamps(new Set()); }

        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">
            <div className="max-w-6xl mx-auto px-4 py-6">
              <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                <div>
                  <h1 className="text-3xl font-bold">NeuroQuest @ MPI‑BI</h1>
                  <p className="text-sm text-gray-600">Visit stations, earn stamps, and climb the board.</p>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-600">Player:</span>
                  <input className="border rounded-xl px-3 py-2 text-sm w-40 bg-white" placeholder="Nickname" value={name} onChange={(e) => setName(e.target.value)} />
                </div>
              </header>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-4">
                  {stations.map(({ id, Component }) => (
                    <Component key={id} onComplete={() => handleComplete(id)} done={stamps instanceof Set ? stamps.has(id) : (new Set(stamps)).has(id)} setBest={setBestMs} />
                  ))}
                </div>
                <div className="space-y-4">
                  <Passport stations={stations} stamps={stamps instanceof Set ? stamps : new Set(stamps)} onReset={resetPassport} />
                  <Leaderboard name={name} setName={setName} bestMs={bestMs} stamps={stamps instanceof Set ? stamps : new Set(stamps)} />
                  <div className="rounded-2xl border p-4 bg-white text-sm text-gray-700">
                    <h3 className="font-semibold mb-2">How to use this in your Open Day</h3>
                    <ol className="list-decimal pl-5 space-y-1">
                      <li>Host this page on any static site (e.g., Netlify Drop, GitHub Pages).</li>
                      <li>Share the URL via QR code. Progress is saved locally on each device.</li>
                      <li>Optionally project a separate leaderboard at a kiosk.</li>
                    </ol>
                    <p className="mt-2">No backend or sign-in. All data stays on the device (localStorage).</p>
                  </div>
                </div>
              </div>

              <footer className="mt-8 text-center text-xs text-gray-500">
                © MPI‑BI Open Day demo — single HTML file (React + Tailwind CDNs).
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>