<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fly‚ÄëLeague @ MPI‚ÄëBI</title>
    <meta name="description" content="Compare your skills to a thousand fruit flies: vision, reaction time, landing precision." />
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      // ---------- Utils ----------
      const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
      const formatMs = (ms) => `${Math.round(ms)} ms`;

      function useLocalStorage(key, initialValue) {
        const [value, setValue] = useState(() => {
          try {
            const raw = window.localStorage.getItem(key);
            return raw
              ? JSON.parse(raw, (k, v) =>
                  v && v.__set ? new Set(v.values) : v
                )
              : initialValue;
          } catch {
            return initialValue;
          }
        });
        useEffect(() => {
          try {
            const replacer = (k, v) =>
              v instanceof Set ? { __set: true, values: Array.from(v) } : v;
            window.localStorage.setItem(key, JSON.stringify(value, replacer));
          } catch {}
        }, [key, value]);
        return [value, setValue];
      }

      function Button({ children, onClick, disabled, variant = "primary" }) {
        const base = "px-3 py-2 rounded-xl text-sm font-medium transition active:scale-[.98]";
        const styles =
          variant === "ghost"
            ? "border border-gray-200 hover:bg-gray-50"
            : disabled
            ? "bg-gray-300 text-white"
            : "bg-blue-600 text-white hover:bg-blue-700";
        return (
          <button className={`${base} ${styles}`} onClick={onClick} disabled={disabled}>
            {children}
          </button>
        );
      }

      function Card({ title, children, footer, done }) {
        return (
          <div className={"rounded-2xl shadow p-5 bg-white border " + (done ? "border-green-400" : "border-gray-200")}>
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-xl font-semibold">{title}</h3>
              {done ? (
                <span className="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Stamped</span>
              ) : (
                <span className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">Do task</span>
              )}
            </div>
            <div>{children}</div>
            {footer && <div className="mt-4 text-sm text-gray-600">{footer}</div>}
          </div>
        );
      }

      // ---------- Station 1: Fly‚ÄëEye Illusions ----------
      function StationFlyEye({ onComplete, done, setIllusionMistakes }) {
        const [questionIndex, setQuestionIndex] = useState(0);
        const [mistakes, setMistakes] = useState(0);
        useEffect(() => setIllusionMistakes && setIllusionMistakes(mistakes), [mistakes, setIllusionMistakes]);

        const trials = useMemo(() => [
          { pattern: "‚ñ∂‚ñ∂‚ñ∂‚ñ∂‚ñ∂", correct: "right" },
          { pattern: "‚óÄ‚óÄ‚óÄ‚óÄ‚óÄ", correct: "left" },
          { pattern: "‚ñ∂‚ñ∂‚óÄ‚óÄ‚ñ∂", correct: "right" },
          { pattern: "‚óÄ‚ñ∂‚óÄ‚ñ∂‚óÄ", correct: "left" },
        ], []);
        const current = trials[questionIndex];

        function answer(dir) {
          if (dir === current.correct) {
            if (questionIndex === trials.length - 1) onComplete();
            else setQuestionIndex((i) => i + 1);
          } else {
            setMistakes((m) => m + 1);
            alert("Not quite ‚Äî think how wide‚Äëfield motion drives turning.");
          }
        }

        return (
          <Card title="Fly‚ÄëEye Illusions (Vision)" done={done}
            footer={<>Flies turn toward wide‚Äëfield motion (optomotor response). Which way does the pattern make you turn?</>}>
            <div className="flex items-center justify-between gap-3">
              <div className="text-4xl tracking-widest select-none font-mono">{current.pattern}</div>
              <div className="flex gap-2">
                <Button onClick={() => answer("left")}>Left</Button>
                <Button onClick={() => answer("right")}>Right</Button>
              </div>
            </div>
            <div className="text-xs text-gray-500 mt-2">Mistakes: {mistakes}</div>
          </Card>
        );
      }

      // ---------- Station 2: Synapse Snap (Reaction Time) ----------
      function StationReaction({ onComplete, done, setBestRt }) {
        const [state, setState] = useState("idle"); // idle -> waiting -> go -> done
        const [rt, setRt] = useState(null);
        const startTs = useRef(0);
        const timeoutRef = useRef(null);

        function begin() {
          setRt(null);
          setState("waiting");
          const delay = 600 + Math.random() * 1800; // 0.6‚Äì2.4 s
          timeoutRef.current = setTimeout(() => {
            startTs.current = performance.now();
            setState("go");
          }, delay);
        }

        function tap() {
          if (state !== "go") {
            alert("Too early! Wait for the signal.");
            return;
          }
          const t = performance.now() - startTs.current;
          setRt(t);
          setBestRt && setBestRt((prev) => (prev == null ? t : Math.min(prev, t)));
          setState("done");
          if (t < 350) onComplete();
        }

        useEffect(() => () => clearTimeout(timeoutRef.current), []);

        return (
          <Card title="Synapse Snap (Reaction Time)" done={done}
            footer={<>Typical human visuo‚Äëmotor reaction ‚âà 200‚Äì250 ms. Synaptic delay per synapse ~1‚Äì2 ms.</>}>
            <div className="flex flex-col sm:flex-row items-stretch gap-3">
              <div className="flex-1">
                {state === "idle" && (<Button onClick={begin}>Ready ‚Üí Wait for signal</Button>)}
                {state === "waiting" && (<div className="p-3 rounded-xl bg-yellow-50 border border-yellow-200">Wait‚Ä¶</div>)}
                {state === "go" && (<Button onClick={tap}>TAP!</Button>)}
                {state === "done" && (
                  <div className="flex items-center gap-3">
                    <div className="p-2 rounded-xl bg-blue-50 border">Your RT: <b>{formatMs(rt)}</b></div>
                    <Button variant="ghost" onClick={begin}>Try again</Button>
                  </div>
                )}
              </div>
            </div>
          </Card>
        );
      }

      // ---------- Station 3: Landing Challenge (clarified) ----------
      function StationLanding({ onComplete, done, setLandingError }) {
        // One‚Äëtap landing: tap once to cut engines.
        // GOAL: stop with the CENTER of the blue capsule INSIDE the green band.
        // The closer the center is to the band‚Äôs CENTER LINE, the better.
        const [y, setY] = useState(0);
        const [v, setV] = useState(0.5); // px per tick
        const [running, setRunning] = useState(true);
        const [stopped, setStopped] = useState(false);
        const [platformTop] = useState(180 + Math.round(Math.random() * 60)); // 180‚Äì240
        const platformThickness = 20; // touchdown zone thickness (px)

        useEffect(() => {
          if (!running) return;
          const id = setInterval(() => {
            setY((prev) => Math.min(prev + v, 260));
            setV((prev) => Math.min(prev + 0.15, 4)); // gravity
          }, 30);
          return () => clearInterval(id);
        }, [running, v]);

        function cut() {
          if (stopped) return;
          setRunning(false);
          setStopped(true);
          const capsuleCenter = y + 16; // circle is 32px tall, center = y + 16
          const bandCenter = platformTop + platformThickness / 2;
          const err = Math.abs(capsuleCenter - bandCenter);
          setLandingError && setLandingError(err);
          const inside = capsuleCenter >= platformTop && capsuleCenter <= platformTop + platformThickness;
          if (inside) {
            onComplete();
          } else {
            alert("Missed the touchdown zone ‚Äî aim so the BLUE center is inside the GREEN band.");
          }
        }

        function reset() {
          setY(0);
          setV(0.5);
          setRunning(true);
          setStopped(false);
        }

        const capsuleCenterY = y + 16;
        const bandCenterY = platformTop + platformThickness / 2;
        const offset = Math.round(Math.abs(capsuleCenterY - bandCenterY));
        const status = capsuleCenterY < platformTop
          ? "Above band"
          : capsuleCenterY > platformTop + platformThickness
          ? "Below band"
          : "Inside band ‚úì";

        return (
          <Card title="Landing Challenge (Motor timing)"
            done={done}
            footer={<>
              Tap <b>once</b> to cut engines. <b>Goal:</b> center of the blue capsule <b>inside</b> the <span className="text-green-700">green band</span>.
              Smaller offset to the center line = better.
            </>}>
            <div className="flex items-start gap-4">
              <div className="relative w-64 h-72 rounded-xl border bg-gradient-to-b from-slate-50 to-slate-100 overflow-hidden">
                {/* Touchdown band */}
                <div className="absolute left-0 right-0 bg-green-200" style={{ top: platformTop + "px", height: platformThickness + "px" }} />
                {/* Band center line */}
                <div className="absolute left-0 right-0 border-t border-green-600/60" style={{ top: (platformTop + platformThickness / 2) + "px" }} />
                {/* Capsule (32px, so center = y + 16) */}
                <div className="absolute left-28 w-8 h-8 rounded-full bg-blue-500 shadow" style={{ top: y + "px" }} />
                {/* Capsule center marker */}
                <div className="absolute left-[calc(7rem+0.5rem)] w-0 h-0" style={{ top: (capsuleCenterY) + "px" }}>
                  <div className="w-2 h-2 -ml-1 -mt-1 rounded-full bg-blue-900"></div>
                </div>
              </div>
              <div className="space-y-2 text-sm">
                <div className="text-gray-700"><b>Status:</b> {status}</div>
                <div className="text-gray-700"><b>Offset to center line:</b> ~{offset} px</div>
                <div className="text-xs text-gray-500">Tip: tap a little <i>before</i> the center line to counter momentum.</div>
                <div className="pt-1">
                  <Button onClick={cut} disabled={!running}>Cut engines</Button>
                  <span className="mx-2"></span>
                  <Button variant="ghost" onClick={reset}>Reset</Button>
                </div>
              </div>
            </div>
          </Card>
        );
      }

      // ---------- Passport, Modal, Leaderboard ----------
      function TierBadge({ count }) {
        let tier = { name: "No tier yet", color: "bg-gray-100 text-gray-700" };
        if (count >= 3) tier = { name: "Gold", color: "bg-yellow-200 text-yellow-900" };
        else if (count >= 2) tier = { name: "Bronze", color: "bg-amber-100 text-amber-800" };
        return <span className={`px-2 py-1 rounded-full text-xs ${tier.color}`}>{tier.name}</span>;
      }

      function Passport({ stations, stamps, onReset }) {
        const count = stamps.size;
        return (
          <div className="rounded-2xl border p-4 bg-white">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-semibold">Fly‚ÄëLeague Passport</h3>
              <TierBadge count={count} />
            </div>
            <div className="grid grid-cols-5 gap-2 mt-3">
              {stations.map((s) => (
                <div key={s.id} className={`aspect-square rounded-xl border flex items-center justify-center text-2xl ${stamps.has(s.id) ? "bg-green-100 border-green-300" : "bg-gray-50 border-gray-200"}`}>
                  {stamps.has(s.id) ? "‚ú≥" : ""}
                </div>
              ))}
            </div>
            <div className="text-sm text-gray-600 mt-3">Complete all 3 tasks to earn <b>Gold</b>.</div>
            <div className="mt-3"><Button variant="ghost" onClick={onReset}>Reset passport</Button></div>
          </div>
        );
      }

      function Modal({ open, onClose, children }) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
            <div className="bg-white rounded-2xl shadow-xl p-5 max-w-md w-full">
              <div className="mb-3">{children}</div>
              <div className="text-right"><Button onClick={onClose}>Close</Button></div>
            </div>
          </div>
        );
      }

      function Leaderboard({ name, setName, stamps, bestRt, landingError, illusionMistakes }) {
        const [board, setBoard] = useLocalStorage("neuroquest_board", []);
        const [saved, setSaved] = useState(false);
        const [modalOpen, setModalOpen] = useState(false);
        const [rankMsg, setRankMsg] = useState("");

        const score =
          (stamps.size || 0) * 1000 -
          (bestRt == null ? 9999 : Math.min(bestRt, 9999)) -
          (landingError == null ? 200 : 5 * landingError) -
          (illusionMistakes == null ? 0 : 200 * illusionMistakes);

        function randn() {
          let u = 0, v = 0;
          while (u === 0) u = Math.random();
          while (v === 0) v = Math.random();
          return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }
        function simulateFlyCohortRank(myScore) {
          const N = 1000;
          let better = 0;
          for (let i = 0; i < N; i++) {
            const rt = Math.max(40, Math.min(220, 90 + randn() * 25));   // ms
            const land = Math.max(0, Math.min(60, 12 + randn() * 8));    // px
            const mistakes = Math.max(0, Math.round(0.6 + randn() * 0.8));
            const s = 3 * 1000 - Math.min(rt, 9999) - 5 * land - 200 * mistakes;
            if (s > myScore) better += 1;
          }
          return { place: better + 1, total: 1000 };
        }

        function save() {
          if (!name) return alert("Enter a nickname first");
          const entry = {
            name,
            score,
            stamps: stamps.size,
            bestRt: bestRt ?? null,
            landingError: landingError ?? null,
            illusionMistakes: illusionMistakes ?? null,
            t: Date.now(),
          };
          const updated = [...board, entry].sort((a, b) => b.score - a.score).slice(0, 20);
          setBoard(updated);
          setSaved(true);

          const { place, total } = simulateFlyCohortRank(score);
          const suffix = place % 10 === 1 && place % 100 !== 11 ? "st"
                       : place % 10 === 2 && place % 100 !== 12 ? "nd"
                       : place % 10 === 3 && place % 100 !== 13 ? "rd"
                       : "th";
          setRankMsg(`Among ${total} flies, you rank ${place}${suffix}.`);
          setModalOpen(true);
        }

        return (
          <div className="rounded-2xl border p-4 bg-white">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-lg font-semibold">Local Leaderboard + Fly Rank</h3>
              <div className="text-sm text-gray-500">Score mixes stamps, RT, landing & mistakes</div>
            </div>
            <div className="flex items-center gap-2 mb-3">
              <input className="border rounded-xl px-3 py-2 text-sm w-40" placeholder="Nickname" value={name} onChange={(e) => setName(e.target.value)} />
              <Button onClick={save}>{saved ? "Saved" : "Save score"}</Button>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="text-left text-gray-600">
                    <th className="py-1 pr-4">#</th>
                    <th className="py-1 pr-4">Name</th>
                    <th className="py-1 pr-4">Stamps</th>
                    <th className="py-1 pr-4">Best RT</th>
                    <th className="py-1 pr-4">Land err</th>
                    <th className="py-1 pr-4">Illus. mistakes</th>
                    <th className="py-1 pr-4">Score</th>
                  </tr>
                </thead>
                <tbody>
                  {board.map((r, i) => (
                    <tr key={r.name + r.t} className="border-t">
                      <td className="py-1 pr-4">{i + 1}</td>
                      <td className="py-1 pr-4">{r.name}</td>
                      <td className="py-1 pr-4">{r.stamps}</td>
                      <td className="py-1 pr-4">{r.bestRt ? formatMs(r.bestRt) : "‚Äî"}</td>
                      <td className="py-1 pr-4">{r.landingError == null ? "‚Äî" : Math.round(r.landingError)}</td>
                      <td className="py-1 pr-4">{r.illusionMistakes == null ? "‚Äî" : r.illusionMistakes}</td>
                      <td className="py-1 pr-4">{Math.round(r.score)}</td>
                    </tr>
                  ))}
                  {board.length === 0 && (<tr><td className="py-2 text-gray-500" colSpan="7">No scores yet. Be the first!</td></tr>)}
                </tbody>
              </table>
            </div>

            <Modal open={modalOpen} onClose={() => setModalOpen(false)}>
              <div className="text-center">
                <div className="text-2xl mb-2">üêù Fly‚ÄëLeague Result</div>
                <div className="text-lg">{rankMsg}</div>
                <div className="text-xs text-gray-500 mt-2">(Simulated cohort for fun; no data leaves your device.)</div>
              </div>
            </Modal>
          </div>
        );
      }

      // ---------- App ----------
      function App() {
        const stations = [
          { id: "fly", title: "Fly‚ÄëEye Illusions", Component: StationFlyEye },
          { id: "rt", title: "Synapse Snap", Component: StationReaction },
          { id: "land", title: "Landing Challenge", Component: StationLanding },
        ];

        const [stamps, setStamps] = useLocalStorage("neuroquest_stamps", new Set());
        const [name, setName] = useLocalStorage("neuroquest_name", "");
        const [bestRt, setBestRt] = useLocalStorage("neuroquest_best_rt", null);
        const [landingError, setLandingError] = useLocalStorage("neuroquest_landing_err", null);
        const [illusionMistakes, setIllusionMistakes] = useLocalStorage("neuroquest_illus_mistakes", 0);

        function handleComplete(id) {
          setStamps((prev) => {
            const s = new Set(prev instanceof Set ? prev : prev);
            s.add(id);
            return s;
          });
        }
        function resetPassport() {
          setStamps(new Set());
          setBestRt(null);
          setLandingError(null);
          setIllusionMistakes(0);
        }

        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">
            <div className="max-w-6xl mx-auto px-4 py-6">
              <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                <div>
                  <h1 className="text-3xl font-bold">Fly‚ÄëLeague @ MPI‚ÄëBI</h1>
                  <p className="text-sm text-gray-600">Compare your skills to a thousand fruit flies ü™∞.</p>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-600">Player:</span>
                  <input className="border rounded-xl px-3 py-2 text-sm w-40 bg-white" placeholder="Nickname" value={name} onChange={(e) => setName(e.target.value)} />
                </div>
              </header>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-4">
                  {stations.map(({ id, Component }) => (
                    <Component
                      key={id}
                      onComplete={() => handleComplete(id)}
                      done={stamps instanceof Set ? stamps.has(id) : (new Set(stamps)).has(id)}
                      setBestRt={id === "rt" ? setBestRt : undefined}
                      setLandingError={id === "land" ? setLandingError : undefined}
                      setIllusionMistakes={id === "fly" ? setIllusionMistakes : undefined}
                    />
                  ))}
                </div>
                <div className="space-y-4">
                  <Passport stations={stations} stamps={stamps instanceof Set ? stamps : new Set(stamps)} onReset={resetPassport} />
                  <Leaderboard
                    name={name}
                    setName={setName}
                    stamps={stamps instanceof Set ? stamps : new Set(stamps)}
                    bestRt={bestRt}
                    landingError={landingError}
                    illusionMistakes={illusionMistakes}
                  />
                  <div className="rounded-2xl border p-4 bg-white text-sm text-gray-700">
                    <h3 className="font-semibold mb-2">How scoring works</h3>
                    <ul className="list-disc pl-5 space-y-1">
                      <li>+1000 points per completed station (3 total).</li>
                      <li>‚àí your best reaction time (ms).</li>
                      <li>‚àí 5 √ó landing offset (pixels).</li>
                      <li>‚àí 200 √ó illusion mistakes.</li>
                    </ul>
                    <p className="mt-2 text-xs text-gray-500">‚ÄúFly cohort‚Äù is simulated for fun; no data leaves your device.</p>
                  </div>
                </div>
              </div>

              <footer className="mt-8 text-center text-xs text-gray-500">
                ¬© MPI‚ÄëBI Open Day ‚Äî Fly Edition. Single-file app.
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>